name: Terraform Force Unlock

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to unlock (dev/prod)"
        required: true
        type: choice
        options:
          - dev
          - prod
      lock_id:
        description: "Lock ID to force unlock (get from error message)"
        required: true
        type: string

env:
  TF_VERSION: "1.13.5"

jobs:
  force-unlock:
    name: Force Unlock Terraform State
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Google Auth
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        working-directory: terraform/environments/${{ inputs.environment }}
        run: terraform init

      - name: Force Unlock
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "üîì Force unlocking state with Lock ID: ${{ inputs.lock_id }}"
          terraform force-unlock -force ${{ inputs.lock_id }}
          echo "‚úÖ State unlocked successfully"

      - name: Verify State
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "üîç Verifying state is accessible..."
          terraform plan -detailed-exitcode || echo "State is now accessible"
